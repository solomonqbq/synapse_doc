# 点播相关接口:点播上传视频接口

## 接口地址

[http://emkt.sfaessentials.com/v2/aj/vod/create](http://emkt.sfaessentials.com/v2/aj/vod/create)

## 接口描述

> 点播上传视频接口

## 认证方式

> 登录认证

## 请求参数(POST):

 输入参数(用get方式。拼装到url地址后面)

|参数  |	必选  |	类型   |	描述|
| ---- | ---- | ----- | ----- | ----- | 
|fileName|是|String	| 视频频文件本地名称，如果包含中文空格，则需要使用rawurlencode编码，长度在40个字符以内，不得包含\ / : * ? “ < > | 等字符|
|fileSha  |   是|String|视频文件的sha，采用SHA-1计算文件内容|
|fileSize|    是|Int|视频文件的总大小，单位字节Byte|
|dataSize| 是|Int|本次上传的分片大小，单位字节kb。dataSize值建议不超过5M Byte|
|nextOffset |       是|Int|本次上传分片在视频文件的偏移量，单位是kb，第一片为0，后续偏移量可按照上一次操作的返回|
|isTranscode|否|Int|	是否转码，0：否，1：是，默认为0；如果不执行转码，可在上传后，在管理控制台视频文件管理进行转码；|
|isScreenshot|否|Int	|是否截图，0：否，1：是，默认为0|
|isWatermark|否|Int	|是否打水印，0：否，1：是，默认为0；如果选择打水印，请务必在管理控制台提前完成水印文件选择和位置设定，否则可能导致上传失败|

二进制视频文件内容直接放到post中


## 输出参数data 字段描述

|参数名称	|类型|	描述|
| ---- | ---- | ----- | 
|code	|Int|	错误码, 0: 成功, 其他值: 失败|
|message|	String|	错误信息|
|flag	|Int	|是否最后一片，0：上传未完成，1：整个文件上传完成|
|offset	|String|	下一片数据应该从什么偏移继续上传，flag为0时才有值|
|fileId	|String|	视频文件的ID，flag为1时才有值


- [接口调用demo](api/aj/vod/demo)


## 上传流程说明

##### 对于视频文件，一般为文件比较大，所以需要采用分片上传的方法，create 接口正是使用了这种分片上传的方法。

### 什么是分片上传?

##### 分片上传功能是将一个文件切割为一系列特定大小的小数据片，分片将这些数据片分别上传到服务器中，这些小的数据片在服务器中会再次合成一个资源，通过对文件的sha值进行校验，以保证合并后的文件为一个完整的，与用户上传的文件内容一致的文件。

##### 分片上传的好处有两个，

##### 一个是防止网络不稳定导致的上传失败,另一个是允许断点续传。缺点是协议变得复杂，对于api使用者使用增大了一定的难度。我们可以通过下图理解分片上传的过程。

![image](/uploads/e4366797c526cc561b5fcf25d704c155/image.png)

##### 从上图可以看出，分片上传完成后，会合并成一个文件，同时计算文件内容的sha值，如果与原始文件的sha值相同，这时文件上传成功。

##### 从上图可以看出，决定一个文件的分片有两个值，分别是偏移量(对应参数Offset)和分片大小(对应参数dataSize)，通过这两个参数，我们可以从一个文件中定位出该分片并取出它相应的内容，如下图所示。

![image](/uploads/d8cc79a202b84d10a4381e133eacb3c2/image.png)


##### 因此，每次请求的方式以分片为粒度，使用create接口，构造上传完整文的流程如下图所示。

![image](/uploads/b0a4257261985187a5340e527ead43f9/image.png)


##### 当客户端需要上传一个文件时，会上传第一个分片，第一个分片的偏移量offset为0，分片的大小dataSize 由上传分片的内容决定，建议最小为512KB 。

##### 服务器接收到数据后，对客户端进行响应，告诉客户端这里已经上传了多少内容，下一次需要上传的偏移量应该从多少开始，这个时候，客户端便需要根据指定的偏移量上传分片数据。其中flag为0表示文件还没有上传完毕。如果文件已经上传完毕，或者文件已经存在服务器上，那么这是服务器响应的内容将flag参数置1，并且返回文件唯一标志fileId。

##### 所以，客户端需要做的就是发起第一个分片上传后，根据服务器的响应，循环地调用create接口以上传服务器指定的下一个分片内容，直至服务器返回文件上传完毕的消息为止。
  
   
   







